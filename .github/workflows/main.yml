name: sakaram.vinasai.ca deploy
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: env
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
      - name: Deploy to Server
        run: |
          set -e

          FRONTEND_ENV_B64="$(printf '%s' "${{ vars.FRONTEND_ENV }}" | base64 -w0)"
          BACKEND_ENV_B64="$(printf '%s' "${{ vars.BACKEND_ENV }}" | base64 -w0)"
          
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
          "SERVER_PATH='${{ secrets.WORK_DIR }}' FRONTEND_DIR='${{ secrets.WORK_DIR }}/frontend' BACKEND_DIR='${{ secrets.WORK_DIR }}/backend' FRONTEND_ENV_B64='$FRONTEND_ENV_B64' BACKEND_ENV_B64='$BACKEND_ENV_B64' bash -s" << 'EOF'
            set -e

            # Define REPO_URL inside the remote script
            REPO_URL='git@github.com:vinasai/sakarama-tours.git'

            echo "--- Starting Deployment ---"
            # Ensure the remote SSH known_hosts is set up for github.com
            mkdir -p ~/.ssh
            ssh-keyscan github.com >> ~/.ssh/known_hosts

            UPLOADS_DIR="$SERVER_PATH/backend/uploads"
            BACKUP_TAR="/tmp/sakaram-uploads-$(date +%Y%m%d-%H%M%S).tar.gz"
            
            if [ -d "$UPLOADS_DIR" ]; then
              echo "Backing up uploads folder from: $UPLOADS_DIR"
              tar -czf "$BACKUP_TAR" -C "$SERVER_PATH" "backend/uploads"
              echo "Uploads backup created at: $BACKUP_TAR"
            else
              echo "No existing uploads folder found at $UPLOADS_DIR (skipping backup)."
              BACKUP_TAR=""
            fi
            
            # Perform a fresh clone
            TEMP_CLONE_DIR="/tmp/sakaram-$(date +%s)"
            echo "Cloning repository into $TEMP_CLONE_DIR..."
            
            git clone "$REPO_URL" "$TEMP_CLONE_DIR"
            
            # Replace the old application code
            echo "Updating application code in $SERVER_PATH..."
            rm -rf "$SERVER_PATH"
            mkdir -p "$SERVER_PATH"
            mv "$TEMP_CLONE_DIR"/* "$SERVER_PATH/"
            rm -rf "$TEMP_CLONE_DIR"

            if [ -n "${BACKUP_TAR}" ] && [ -f "$BACKUP_TAR" ]; then
              echo "Restoring uploads folder into: $SERVER_PATH/backend/uploads"
              mkdir -p "$SERVER_PATH/backend"
              tar -xzf "$BACKUP_TAR" -C "$SERVER_PATH"
              echo "Uploads restored."
            else
              echo "No uploads backup to restore (skipping restore)."
            fi
            
            # --- Deploy the frontend (Next.js) ---
            echo "Deploying frontend..."
            cd "$FRONTEND_DIR"
            
            yarn install
            echo "Building the application..."

            echo "Writing frontend .env..."
            echo "$FRONTEND_ENV_B64" | base64 -d > .env
            chmod 600 .env
            
            yarn run build

            if [ -d "build" ]; then
              BUILD_FOLDER="build"
            elif [ -d "dist" ]; then
              BUILD_FOLDER="dist"
            elif [ -d ".next" ]; then
              BUILD_FOLDER=".next"
            else
              echo "No build output folder found for frontend! Exiting..."
              exit 1
            fi
            echo "Found frontend build folder: $BUILD_FOLDER"
            
            # Clean up folder logic
            find . -mindepth 1 -maxdepth 1 ! -name "$BUILD_FOLDER" ! -name "api" -exec rm -rf {} +
            
            mv "$BUILD_FOLDER"/* .
            rm -rf "$BUILD_FOLDER"
                      
            echo "Restarting Nginx..."
            sudo systemctl restart nginx

            cd "$BACKEND_DIR"
            
            yarn install --production=false
            echo "Building the application..."

            echo "Writing backend .env..."
            echo "$BACKEND_ENV_B64" | base64 -d > .env
            chmod 600 .env

            pm2 describe sakaram.vinasai.ca-backend >/dev/null 2>&1 && pm2 restart sakaram.vinasai.ca-backend --update-env || pm2 start npm --name sakaram.vinasai.ca-backend -- start
            pm2 save

            # rm -f .env .env.production
            
            echo "--- Deployment Finished Successfully ---"
          EOF
